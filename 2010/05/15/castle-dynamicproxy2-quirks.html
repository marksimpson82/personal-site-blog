<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Castle DynamicProxy2 quirks - Mark’s Devblog</title>
<meta name="description" content="I’ve been faffing around with Castle.DynamicProxy2 a bit lately and it’s a pretty interesting bit of kit. Castle Dynamic Proxy (CDP) allows you to dynamically generate proxies at runtime to weave aspects of behaviour into existing types. Aspect oriented programming is typically employed for implementing crosscutting concerns such as logging, performance measuring, raising INotifyPropertyChanged and various other types of repetitive and/or orthogonal concerns. I’m a newbie to this stuff so I won’t say much more on AOP.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Mark's Devblog">
<meta property="og:title" content="Castle DynamicProxy2 quirks">
<meta property="og:url" content="https://marksimpson82.github.io/blog/2010/05/15/castle-dynamicproxy2-quirks.html">


  <meta property="og:description" content="I’ve been faffing around with Castle.DynamicProxy2 a bit lately and it’s a pretty interesting bit of kit. Castle Dynamic Proxy (CDP) allows you to dynamically generate proxies at runtime to weave aspects of behaviour into existing types. Aspect oriented programming is typically employed for implementing crosscutting concerns such as logging, performance measuring, raising INotifyPropertyChanged and various other types of repetitive and/or orthogonal concerns. I’m a newbie to this stuff so I won’t say much more on AOP.">







  <meta property="article:published_time" content="2010-05-15T15:35:31+00:00">





  

  


<link rel="canonical" href="https://marksimpson82.github.io/blog/2010/05/15/castle-dynamicproxy2-quirks.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mark's Devblog",
      "url": "https://marksimpson82.github.io/blog/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Mark's Devblog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Mark's Devblog
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Castle DynamicProxy2 quirks">
    <meta itemprop="description" content="I’ve been faffing around with Castle.DynamicProxy2 a bit lately and it’s a pretty interesting bit of kit. Castle Dynamic Proxy (CDP) allows you to dynamically generate proxies at runtime to weave aspects of behaviour into existing types. Aspect oriented programming is typically employed for implementing crosscutting concerns such as logging, performance measuring, raising INotifyPropertyChanged and various other types of repetitive and/or orthogonal concerns. I’m a newbie to this stuff so I won’t say much more on AOP.">
    <meta itemprop="datePublished" content="2010-05-15T15:35:31+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Castle DynamicProxy2 quirks
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>I’ve been faffing around with <a href="http://www.castleproject.org/dynamicproxy/index.html">Castle.DynamicProxy2</a> a bit lately and it’s a pretty interesting bit of kit. Castle Dynamic Proxy (CDP) allows you to dynamically generate proxies at runtime to weave aspects of behaviour into existing types. Aspect oriented programming is typically employed for implementing crosscutting concerns such as logging, performance measuring, raising INotifyPropertyChanged and various other types of repetitive and/or orthogonal concerns. I’m a newbie to this stuff so I won’t say much more on AOP.</p>

<p>While I really like CDP, I’ve found that the documentation and tutorials (the best of which is <span>Krzysztof Koźmic</span>’s excellent <a href="http://kozmic.pl/archive/2009/04/27/castle-dynamic-proxy-tutorial.aspx">tutorial series</a>) aren’t particularly explicit on <strong>how</strong> CDP achieves its effects, and sometimes these details are important.</p>

<p>There are two main ways of creating proxies that most developers will encounter.</p>

<h3 id="createclassproxy">CreateClassProxy</h3>

<p>This is nearly always the first demonstrated method in tutorials. <a href="http://api.castleproject.org/html/Overload_Castle_DynamicProxy_ProxyGenerator_CreateClassProxy.htm">ProxyGenerator.CreateClassProxy</a> dynamically subclasses the target class, so if you have a class named Pogo and you call ProxyGenerator.CreateClassProxy, what you’ll get back is an instance of a <em>subclass</em> of Pogo (i.e. the new type <em>is-a</em> Pogo) that weaves in the interception behaviour via overriding methods. This is why it is a stipulation that methods / properties must be virtual when they’re intercepted.</p>

<p>With class based interceptors, you cannot intercept non virtual methods because unlike Java, C# does not make methods virtual by default. If you try to intercept a non-virtual method, nothing will happen, though mechanisms do exist to allow you to identify these situations and warn the developer (the most common example of this is that NHibernate will die on its arse if you try to use lazy loading with a non-virtual member).</p>

<h3 id="createinterfaceproxywithtarget">CreateInterfaceProxyWithTarget</h3>

<p>The second method is <a href="http://api.castleproject.org/html/Overload_Castle_DynamicProxy_ProxyGenerator_CreateInterfaceProxyWithTarget.htm">ProxyGenerator.CreateInterfaceProxyWithTarget</a>, and it is the primary reason for writing this blog post! CreateInterfaceProxyWithTarget does not dynamically subclass target types, it simply creates a dynamically generated class, implements the same target interface and then passes through to it. I.e. it’s an implementation of the <a href="http://en.wikipedia.org/wiki/Decorator_pattern">decorator pattern</a>. This has two effects, one of which is very important!</p>

<ol>
  <li>You don’t need to mark your methods/properties as virtual</li>
  <li>Since it is a proxy working via decoration rather than subclassing, for the effects of the interceptor to be applied, all calls must be made <strong>on the proxy instance</strong>. Think about it.</li>
</ol>

<p>The most salient point is #2. I’ll elaborate.</p>

<h3 id="a-worked-example-rocky-balboa">A worked example: Rocky Balboa</h3>

<p>Say you have an interface called IBoxer like this:</p>

<p><img class="alignnone" src="images/iboxer.png" alt="" width="213" height="124" /></p>

<p>… and you implement it like this:</p>

<p><img class="alignnone" src="images/rocky.png" alt="" width="473" height="384" /></p>

<p>If you then turn to aspect oriented programming and decide to gather statistics on punches thrown for the duration of a boxing round, it’s a reasonable assumption that you can simply proxy the IBoxer interface and intercept only the StraightLeft/StraightRight punch calls, tally them up and report the metrics (ignore whether this is a good idea to be doing this, it’s a contrived example). On the face of it this isn’t a horrible idea. However, it won’t work as expected.</p>

<p>The key here is that OneTwo() calls through to StraightLeft() and StraightRight(). Once the proxy has delegated to the decorated type it loses the ability to intercept the calls. We can follow the call graph easily enough. We have a reference to the proxy via the IBoxer interface. We call “OneTwo()” on it and when the invocation proceeds, it delegates to the decorated Rocky instance. The Rocky instance then calls StraightLeft(), StraightRight(). Both of these calls will immediately go straight to the ‘real’ implementation, bypassing the proxy.</p>

<p>Just as with the normal decorator pattern, the decorator (the IBoxer dynamic proxy in this case) loses its influence when the decorated object calls methods declared in its own public interface. In this particular situation we could write an interceptor that knows to add two punches when OneTwo() is called on the proxy, but compare this approach to one using class based proxy. If we were using a class proxy we could rest safe in the knowledge that all calls to StraightLeft() and StraightRight() will always be intercepted, as the extra stuff we’ve bolted on resides in a method override.</p>

<p>The results vary depending on the type of proxy we generate and the way the types are written. In hindsight it’s pretty obvious, but it still caught me out.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/tags/advice" class="page__taxonomy-item" rel="tag">advice</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/aop" class="page__taxonomy-item" rel="tag">aop</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/c" class="page__taxonomy-item" rel="tag">c#</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/castle-dynamic-proxy" class="page__taxonomy-item" rel="tag">castle-dynamic-proxy</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/gotchas" class="page__taxonomy-item" rel="tag">gotchas</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/patterns" class="page__taxonomy-item" rel="tag">patterns</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/software" class="page__taxonomy-item" rel="tag">software</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2010-05-15T15:35:31+00:00">May 15, 2010</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Castle+DynamicProxy2+quirks%20https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2010%2F05%2F15%2Fcastle-dynamicproxy2-quirks.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2010%2F05%2F15%2Fcastle-dynamicproxy2-quirks.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2010%2F05%2F15%2Fcastle-dynamicproxy2-quirks.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/2010/05/08/data-driven-testing-tricks.html" class="pagination--pager" title="Data-driven testing tricks
">Previous</a>
    
    
      <a href="/blog/2010/06/09/terms-that-mildly-displease-me-243-244.html" class="pagination--pager" title="Terms that mildly displease me
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/10/the-fundamentals-of-automated-testing-setup-structure.html" rel="permalink">The fundamentals of unit testing: Setup structure
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/05/the-fundamentals-of-automated-testing-data-driven-tests.html" rel="permalink">The fundamentals of unit testing: Data-driven tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/02/goodbye-wordpress-hello-jekyll-and-github-pages.html" rel="permalink">Goodbye Wordpress, Hello Jekyll and Github Pages
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve been using Wordpress with 34sp.com hosting since the late noughties, and it’s time for a 
change.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/03/29/nvidia-g-sync-black-screen-when-alt-tabbing.html" rel="permalink">Nvidia + G-SYNC - Black screen when alt-tabbing
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">tl;dr: It seems G-SYNC related. I fixed it by installing the monitor driver, then toggling G-SYNC on/off.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Mark's Devblog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
