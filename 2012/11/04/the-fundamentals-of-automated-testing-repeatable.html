<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>The fundamentals of unit testing: Repeatable - Mark’s Devblog</title>
<meta name="description" content="This post is part of a series on unit testing.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Mark's Devblog">
<meta property="og:title" content="The fundamentals of unit testing: Repeatable">
<meta property="og:url" content="https://marksimpson82.github.io/blog/2012/11/04/the-fundamentals-of-automated-testing-repeatable.html">


  <meta property="og:description" content="This post is part of a series on unit testing.">







  <meta property="article:published_time" content="2012-11-04T06:54:25+00:00">





  

  


<link rel="canonical" href="https://marksimpson82.github.io/blog/2012/11/04/the-fundamentals-of-automated-testing-repeatable.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mark's Devblog",
      "url": "https://marksimpson82.github.io/blog/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Mark's Devblog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Mark's Devblog
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="The fundamentals of unit testing: Repeatable">
    <meta itemprop="description" content="This post is part of a series on unit testing.">
    <meta itemprop="datePublished" content="2012-11-04T06:54:25+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">The fundamentals of unit testing: Repeatable
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>This post is <a href="/blog/2012/10/24/the-fundamentals-of-automated-testing-series.html">part of a series</a> on unit testing.</p>

<p>The main purpose of automated testing is to highlight problems with correctness in production code. When a test fails, it means, “something is wrong here; we have a bug in our production code!” I’m sorry about your canary. It died a valiant death.</p>

<h2 id="tests-should-be-repeatable">Tests Should be Repeatable</h2>

<p>… so what do I mean when I say that tests should be repeatable? By repeatable, I mean each test can be executed an arbitrary number of times without observing a change in the test results. If a developer can run a unit test 100 times in a row and get two or more distinct results <strong>without</strong> altering any production/test code, the test is not repeatable.</p>

<h2 id="why-should-i-care">Why Should I Care?</h2>

<p>If a unit test cannot yield the same result with every single test run, then it is non-deterministic and untrustworthy.</p>

<p>An unreliable, flaky test is analogous to a car alarm that has been going off for two days. There <em>might</em> be something wrong, but nobody will pay any attention to it.</p>

<p>Most people who’ve worked with large test suites will have experienced a particular situation from time to time – the case where a handful of the tests intermittently fail. Developers quickly recognise the problematic test name(s) and exclaim, “these tests sometimes fail for no reason”. The next step is to click the “rebuild” button on the continuous integration server. Without changing a thing, the tests pass. Hooray! If you joined in with the cheering, then please punch yourself in the face (it was a ruse).</p>

<p>When folk mindlessly click the “rebuild” button, we’ve lost. At this juncture, the developers don’t trust the tests. Remember when I said that the purpose of tests is to act as a canary in the mine? Well, the canary died and, rather than saying “everyone out of the shaft!” their first reaction was to send in more, as perhaps the first one had asthma or died of natural causes. If people merely gloss over the root cause of the failure and try to make the failure “go away”, this signals a collective shift into <a href="http://www.urbandictionary.com/define.php?term=NOMFup">NOMFuP</a>-land. If you’re unfamiliar with NOMFuP, I recommend watching <a href="http://uk.imdb.com/title/tt0459159/">The Thick of It</a>.</p>

<blockquote>
  <p><strong><a href="http://uk.imdb.com/name/nm0134922/">Malcolm Tucker</a></strong>: NOMFuP.<br />
<strong><a href="http://uk.imdb.com/name/nm0383467/">Jamie</a></strong>: Eh?<br />
<strong><a href="http://uk.imdb.com/name/nm0134922/">Malcolm Tucker</a></strong>: NOMFuP. N-O-M-F-P. Not My Fucking Problem.</p>
</blockquote>

<h2 id="causes">Causes</h2>

<p>Some of the causes of an unreliable test can be found on the previously-blogged 
<a href="/blog/2012/11/02/the-fundamentals-of-automated-testing-atomic.html">Atomic</a> post (basically: global/static
state and environment dependencies).</p>

<p>However, there are some other issues that can cause tests to fail.</p>

<h3 id="threading">Threading</h3>

<p>Any kind of unit test involving threading should set alarm bells ringing. Threading tests immediately take a dependency on the environment, as thread interleaving is non-deterministic. As such, any test involving threads can highlight race conditions amongst other things.</p>

<p>I.e. if threading is used in tests, that test is by default not a unit test. You should note that neither the test nor the class under test should be creating threads.</p>

<p>While there’s nothing inherently wrong about using threads in integration/functional tests, careful decisions have to be made about how to make each test robust. Threading is notoriously easy to get wrong and introduces the scope for several classes of bugs you won’t see in single-threaded code.</p>

<p>Here’s an example of a test that spins up a thread (again, please do not use this as an example of how to do things, as it’s flawed in several ways). I’ve highlighted the lines in the test body that involve threading concerns:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>  
<span class="k">public</span> <span class="k">void</span> <span class="nf">TestLocking</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="kt">var</span> <span class="n">ptr</span> <span class="p">=</span> <span class="n">Memory</span><span class="p">.</span><span class="nf">Alloc</span><span class="p">(</span><span class="m">128</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="s">"Memory"</span><span class="p">);</span>  
 <span class="n">Thread</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Memory</span><span class="p">.</span><span class="nf">MemSet</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">128</span><span class="p">));</span>  
 <span class="n">t2</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

 <span class="k">while</span> <span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">)</span>  
 <span class="p">{</span>  
 <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>  
 <span class="p">}</span>

 <span class="n">Memory</span><span class="p">.</span><span class="nf">Free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>Ignoring the non-descriptive name and the lack of a meaningful assert, this is a fairly simple test that seems to be checking that a memory system can allocate and de-allocate across different threads, yet the majority of the code is dealing with threading concerns. Threaded tests run the risk of race conditions, re-entrancy problems, deadlock, livelock and all of the rest. Also, the more lines of imperative code added to tests, the more risky it is that a bug will be introduced <em>in the test itself</em>.</p>

<p>The main reason to avoid threading in unit tests is that threading is dependent on the machine configuration. Microsoft discovered the vast majority of its Windows threading bugs when running integration/end to end tests on an eight core machine. However, the same tests passed without an issue on machines with one or two cores. Bearing this in mind, do you <em>really</em> want to play Russian roulette with your unit tests? I don’t.</p>

<p>As I said, I’m not trying to entirely dissuade folk from testing threaded code, but to be aware that they’re not unit tests and that special care and consideration must be taken when doing so.</p>

<h3 id="timing">Timing</h3>

<p>Timing is related to threading, but typically manifests itself as the test code having to work around timing issues present in the class under test (as opposed to spinning up threads in the test code).</p>

<p>Here’s an example (again, please don’t etc. and so forth – it’s not great code):</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>  
<span class="k">public</span> <span class="k">void</span> <span class="nf">LoadRequestTest</span><span class="p">()</span>  
<span class="p">{</span>  
 <span class="n">Command</span> <span class="n">command</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Command</span><span class="p">(</span>
   <span class="n">PipeCodes</span><span class="p">.</span><span class="n">Loader_PathFile</span><span class="p">,</span> <span class="n">etc</span> <span class="p">...,</span> <span class="k">null</span><span class="p">);</span>
 <span class="n">ResourceSystem</span><span class="p">.</span><span class="n">commandQueue</span><span class="p">.</span><span class="nf">ExternalEnqueue</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>

 <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
 <span class="k">while</span> <span class="p">((</span><span class="n">command</span><span class="p">.</span><span class="n">OpCode</span> <span class="p">!=</span> <span class="n">OpCodes</span><span class="p">.</span><span class="n">Error</span><span class="p">)</span> <span class="p">&amp;&amp;</span>  
 <span class="p">(</span><span class="n">count</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">))</span>  
 <span class="p">{</span>  
 <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span> <span class="c1">// Why 10?  </span>
 <span class="n">count</span><span class="p">++;</span>  
 <span class="p">}</span>

 <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">OpCode</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>The name isn’t very helpful, but let’s just focus on the timing concerns. Notice that there is no sign of threading. The production code is spinning up threads under the hood, though. Aside from the difficulty understanding the intent of the test, the test relies on the magic number of 10 milliseconds. Presumably something (I’m not quite sure what) takes time to process, so the loop has 100 iterations in which to succeed, and a value to wait after each pass of the loop.</p>

<p>Not only does this test have readability issues and a load of logic cooked in, but it is sensitive to timing issues. Just because 10 milliseconds was an adequate sleep value on one PC doesn’t mean it will work on another. Worse still, if functionality that this class relies on changes or the machine is overloaded when the test runs, the test may fail. I’ve seen this multiple times when flaky tests run fine on developer machines, but fail on CI server(s) because they’re under more load. Furthermore, this test is running-in-molasses <em>slooooooooow</em> due to the Sleep() call.</p>

<h2 id="alternatives">Alternatives</h2>

<p>There are a few ways to improve these problems or eliminate them entirely in unit test situations.</p>

<h3 id="dont-unit-test-threaded-code">Don’t unit test threaded code</h3>

<p>The first and simplest suggestion is to avoid writing unit tests for threaded or timing-sensitive code. If you are stuck with inflexible threading model and cannot change it, write integration tests with plenty of timing slack, instead. If you can change the code, read on.</p>

<h3 id="hollywood-principle">Hollywood principle</h3>

<p>The first improvement is to alter the class API to follow the <a href="http://shiman.wordpress.com/2008/09/11/c-net-delegates-asynchronous-invocation-endinvoke-method/">asynchronous invocation</a> model or something similar. Instead of waiting and polling, you can get a callback or block until the operation is completed. While this doesn’t solve the fact that some calls will occur on different threads, it does mean that you can run tests without needing to poll for completion.</p>

<h3 id="decouple-the-threading-model">Decouple the threading model</h3>

<p>The second improvement is to decouple the threading model from the system that uses it. This effectively allows a developer to force the system into a single threaded mode for unit testing. While this will result in any threading issues going undiscovered in the unit tests, these bugs should be covered by complementary integration and end to end tests anyway.</p>

<p>I used this approach to thread resource streaming in a Unity3d project and it worked like a charm. Not only was the code testable, it was doubly useful as, any time errors cropped up, I could just force the system into single threaded mode and (largely) eliminate threading from my enquiries.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/tags/fundamentals-of-unit-testing" class="page__taxonomy-item" rel="tag">fundamentals of unit testing</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/testing" class="page__taxonomy-item" rel="tag">testing</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/tips" class="page__taxonomy-item" rel="tag">tips</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2012-11-04T06:54:25+00:00">November 4, 2012</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=The+fundamentals+of+unit+testing%3A+Repeatable%20https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2012%2F11%2F04%2Fthe-fundamentals-of-automated-testing-repeatable.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2012%2F11%2F04%2Fthe-fundamentals-of-automated-testing-repeatable.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2012%2F11%2F04%2Fthe-fundamentals-of-automated-testing-repeatable.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/2012/11/02/the-fundamentals-of-automated-testing-atomic.html" class="pagination--pager" title="The fundamentals of unit testing: Atomic
">Previous</a>
    
    
      <a href="/blog/2012/11/04/the-fundamentals-of-automated-testing-kiss.html" class="pagination--pager" title="The fundamentals of unit testing: KISS
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/10/the-fundamentals-of-automated-testing-setup-structure.html" rel="permalink">The fundamentals of unit testing: Setup structure
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/05/the-fundamentals-of-automated-testing-data-driven-tests.html" rel="permalink">The fundamentals of unit testing: Data-driven tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/02/goodbye-wordpress-hello-jekyll-and-github-pages.html" rel="permalink">Goodbye Wordpress, Hello Jekyll and Github Pages
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve been using Wordpress with 34sp.com hosting since the late noughties, and it’s time for a 
change.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/03/29/nvidia-g-sync-black-screen-when-alt-tabbing.html" rel="permalink">Nvidia + G-SYNC - Black screen when alt-tabbing
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">tl;dr: It seems G-SYNC related. I fixed it by installing the monitor driver, then toggling G-SYNC on/off.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Mark's Devblog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
