<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Strongly typed commandline arguments - Mark’s Devblog</title>
<meta name="description" content="edit - In modern C# you can use the nameof() expression to do things like this.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Mark's Devblog">
<meta property="og:title" content="Strongly typed commandline arguments">
<meta property="og:url" content="https://marksimpson82.github.io/blog/2009/09/28/strongly-typed-commandline-arguments.html">


  <meta property="og:description" content="edit - In modern C# you can use the nameof() expression to do things like this.">







  <meta property="article:published_time" content="2009-09-28T01:19:24+00:00">





  

  


<link rel="canonical" href="https://marksimpson82.github.io/blog/2009/09/28/strongly-typed-commandline-arguments.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mark's Devblog",
      "url": "https://marksimpson82.github.io/blog/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Mark's Devblog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Mark's Devblog
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Strongly typed commandline arguments">
    <meta itemprop="description" content="edit - In modern C# you can use the nameof() expression to do things like this.">
    <meta itemprop="datePublished" content="2009-09-28T01:19:24+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Strongly typed commandline arguments
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>edit</strong> - In modern C# you can use the <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/nameof"><code class="language-plaintext highlighter-rouge">nameof() expression</code></a> to do things like this.</p>

<p>I’ve read quite a bit about <a href="http://blog.jagregory.com/2009/01/26/introduction-to-static-reflection/" title="Static Reflection">Static Reflection</a> and found it to be very appealing, but I hadn’t used it… until now! Please have a quick look at the article, as I’m not going to parrot its key points, I’m going to write something that is horrendously over-engineered to solve a trivial problem, instead! P.s. I apologise for interchanging arguments/parameters throughout this post. My attention span is akin to that of a hey did anyone play Batman yet?</p>

<p>A bit of background on something I’m working on: I have a c# app that is responsible for starting other processes. Every now and then, the arguments/parameters go out of sync - I change the parameter list in the callee process and the caller, with its piddly weakly-typed guesses, causes the callee to bomb out as the arguments supplied do not match the parameters required.</p>

<p>E.g. I’d write something like:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ProcessFactory</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Process</span> <span class="nf">CreateProcess</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// lots of stuff happens, then I try to make the arguments string</span>
    <span class="c1">// to set as part of the process start info</span>
    <span class="kt">string</span> <span class="n">arguments</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span>
      <span class="s">"-IceCream:{0}"</span><span class="p">,</span> <span class="n">numberOfScoops</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But oh, oh no! I’d renamed “IceCream” to “JimmyNeedsSomeIceCream” or removed it. Since there is no communication between the two processes, it’s hard to write an integration test that proves all is well and, besides, most of the time it’s just down to me renaming or removing an argument. When it bombs out, I then have to go setting breaks points in the callee or trawling through log files. Not ideal. I’d rather the compiler told me when there was an obvious problem. So, my challenge was to make the command line arguments more robust.</p>

<h3 id="you-need-a-target-to-hit">You need a target to hit</h3>

<p>Firstly, I’ll say that if you have non-trivial arguments to parse, the first piece of the puzzle <a href="http://stackoverflow.com/questions/491595/best-way-to-parse-command-line-arguments-in-c">is to grab a good parser</a>. I use one written by <a href="http://blogs.msdn.com/peterhal/archive/2004/10/23/246731.aspx">Peter Hallam</a> (the link on his blog forwards you to a defunct site, but you can find the source in loads of open source projects) which works really nicely. I think I’d rather stop a bus with my face than write another crap command line parser, so it’s always nice to drop an existing, proven one in.</p>

<p>Here’s an example arguments class. Notice that the types are not strings, they can be any simple type that can be parsed:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TargetProcessArguments</span>
<span class="p">{</span>
  <span class="c1">/// &lt;summary&gt;Allow multiple instances?&lt;/summary&gt;</span>
  <span class="p">[</span><span class="nf">Argument</span><span class="p">(</span><span class="n">ArgumentType</span><span class="p">.</span><span class="n">AtMostOnce</span><span class="p">,</span> <span class="n">HelpText</span> <span class="p">=</span> <span class="s">"I'm a knife.  Knifin' around."</span><span class="p">)]</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">NumberOfScoops</span><span class="p">;</span>

  <span class="c1">// etc. and so forth</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Anyway, now you have the parameter names, half of the battle is won. Move the arguments class into a common assembly that both the caller and the callee can access. The next step is using those parameter names in a strongly typed fashion.</p>

<h3 id="latch-on-to-the-target">Latch on to the target</h3>
<p>For this, static reflection fits the bill. Using a slightly modified version of the static reflection code, you can already write code like this:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">GetName_WithValidField_ReturnsFieldName</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">fieldName</span> <span class="p">=</span> <span class="n">StaticReflection</span><span class="p">.</span><span class="n">GetName</span><span class="p">&lt;</span><span class="n">TestClass</span><span class="p">&gt;(</span>
    <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">TestField</span><span class="p">);</span>
  <span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">fieldName</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="nf">EqualTo</span><span class="p">(</span><span class="s">"TestField"</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the above snippet, I’m getting the name of a field or property of a type using static reflection. If the field or property disappears, the compiler will tell me. If it is renamed, the code will update as with normal refactoring.</p>

<p>Here’s my barely modified example based on the first link in this post:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// http://www.lostechies.com/blogs/gabrielschenker/archive/2009/02/03/dynamic-reflection-versus-static-reflection.aspx</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">StaticReflection</span>
<span class="p">{</span>
  <span class="c1">/// &lt;summary&gt;</span>
  <span class="c1">/// Works with either a property or</span>
  <span class="c1">/// a field (simplifies use)</span>
  <span class="c1">/// &lt;/summary&gt;</span>
  <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">GetName</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span>
    <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">memberExpression</span> <span class="p">=</span> <span class="nf">GetMemberExpression</span><span class="p">(</span><span class="n">expression</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">memberExpression</span><span class="p">.</span><span class="n">Member</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">static</span> <span class="n">MemberExpression</span> <span class="n">GetMemberExpression</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">MemberExpression</span> <span class="n">memberExpression</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expression</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">NodeType</span> <span class="p">==</span> <span class="n">ExpressionType</span><span class="p">.</span><span class="n">Convert</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="p">(</span><span class="n">UnaryExpression</span><span class="p">)</span><span class="n">expression</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
      <span class="n">memberExpression</span> <span class="p">=</span> <span class="n">body</span><span class="p">.</span><span class="n">Operand</span> <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">expression</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">NodeType</span> <span class="p">==</span> <span class="n">ExpressionType</span><span class="p">.</span><span class="n">MemberAccess</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">memberExpression</span> <span class="p">=</span> <span class="n">expression</span><span class="p">.</span><span class="n">Body</span> <span class="k">as</span> <span class="n">MemberExpression</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">memberExpression</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span>
        <span class="s">"Not a member access"</span><span class="p">,</span> <span class="s">"expression"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">memberExpression</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s take a bit further, Jimmy. It doesn’t take much effort at all to write a command line argument builder based on the same principles. The existing Static Reflection code is operating on an expression tree. All we need to do is receive an expression tree from the user and (if applicable, a value to go with the param name) and add it to our argument string.</p>

<h3 id="5-minutes-later">5 minutes later</h3>

<p>I wrote a 5 minute job that contained a stringbuilder and added some formatting and a nice fluid interface. Behold!</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">TestParamPair_WithFieldExpression_ParamPairIsWrittenCorrectly</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CommandLineBuilder</span><span class="p">&lt;</span><span class="n">TestArguments</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">ParamPair</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">NumberOfScoops</span><span class="p">,</span> <span class="s">"3"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

  <span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="nf">EqualTo</span><span class="p">(</span><span class="s">"-NumberOfScoops:3"</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So there we go. I can now modify my command line arguments in one project and all callers will be brought up to speed at compile time (or the compiler will tell you that they’ve gone out of synch). Of course, they might still be semantically incorrect, but hey, you can’t have everything.</p>

<p>You could probably extend this further by adding extra validation to the values of the arguments or by setting it on fire.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/tags/c" class="page__taxonomy-item" rel="tag">c#</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/nameof" class="page__taxonomy-item" rel="tag">nameof</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2009-09-28T01:19:24+00:00">September 28, 2009</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Strongly+typed+commandline+arguments%20https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F09%2F28%2Fstrongly-typed-commandline-arguments.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F09%2F28%2Fstrongly-typed-commandline-arguments.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F09%2F28%2Fstrongly-typed-commandline-arguments.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/2009/08/22/understanding-test-doubles.html" class="pagination--pager" title="Understanding test doubles
">Previous</a>
    
    
      <a href="/blog/2009/10/09/internals-to-test-or-not-to-test.html" class="pagination--pager" title="Internals: To test, or not to test?
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/10/the-fundamentals-of-automated-testing-setup-structure.html" rel="permalink">The fundamentals of unit testing: Setup structure
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/05/the-fundamentals-of-automated-testing-data-driven-tests.html" rel="permalink">The fundamentals of unit testing: Data-driven tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/02/goodbye-wordpress-hello-jekyll-and-github-pages.html" rel="permalink">Goodbye Wordpress, Hello Jekyll and Github Pages
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve been using Wordpress with 34sp.com hosting since the late noughties, and it’s time for a 
change.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/03/29/nvidia-g-sync-black-screen-when-alt-tabbing.html" rel="permalink">Nvidia + G-SYNC - Black screen when alt-tabbing
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">tl;dr: It seems G-SYNC related. I fixed it by installing the monitor driver, then toggling G-SYNC on/off.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Mark's Devblog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
