<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Avoiding the file system - Mark’s Devblog</title>
<meta name="description" content="Going from experience and, as illustrated by Misko’s recent presentation, the more dependencies you have on your environment, the less trustworthy and maintainable your tests become. One of the foremost offenders in this area is touching the file system.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Mark's Devblog">
<meta property="og:title" content="Avoiding the file system">
<meta property="og:url" content="https://marksimpson82.github.io/blog/2009/11/26/avoiding-the-file-system.html">


  <meta property="og:description" content="Going from experience and, as illustrated by Misko’s recent presentation, the more dependencies you have on your environment, the less trustworthy and maintainable your tests become. One of the foremost offenders in this area is touching the file system.">







  <meta property="article:published_time" content="2009-11-26T20:21:31+00:00">





  

  


<link rel="canonical" href="https://marksimpson82.github.io/blog/2009/11/26/avoiding-the-file-system.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mark's Devblog",
      "url": "https://marksimpson82.github.io/blog/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Mark's Devblog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Mark's Devblog
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Avoiding the file system">
    <meta itemprop="description" content="Going from experience and, as illustrated by Misko’s recent presentation, the more dependencies you have on your environment, the less trustworthy and maintainable your tests become. One of the foremost offenders in this area is touching the file system.">
    <meta itemprop="datePublished" content="2009-11-26T20:21:31+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Avoiding the file system
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Going from experience and, as illustrated by Misko’s recent presentation, the more dependencies you have on your environment, the less trustworthy and maintainable your tests become. One of the foremost offenders in this area is touching the file system.</p>

<p>Any time someone says “hey, I’m trying to open a file in a unit test…”, my first reaction is to say “woah”, and not in the “I know Kung Fu” way! If you introduce a dependency on the file system, bad things are more likely to happen. You now depend on something that may not be there/accessible/consistent etc. Ever written a test that tried to access a common file, or read a file that something else may write to? It’s horrible.</p>

<p>It is for these reasons that many folk will say “it’s not a unit test if it hits the file system”. In particular, if you have a TestFixtureSetUp/TearDown method that deletes a file, it’s a sure sign that the fixture is going to flake out at some point.</p>

<h3 id="a-real-example">A real example</h3>

<p>Recently at work, my colleagues have experienced the joy of a <strong>huge</strong> refactoring job pertaining to restructuring our projects/solutions to reduce build times and increase productivity. This work included maintaining something close to ten thousand tests.</p>

<p>As the job progressed, they kept finding that some test fixtures did not live in isolation. The tests depended on various things they shouldn’t have and, most saliently, file dependencies proved to be a total pain in the balls. Everything built OK, but when run, the tests failed due to missing files. Paths and file attributes had to be checked (Copy if newer, etc.), lost files had to be hunted down and so forth. It’s hassle that people don’t need! As I’ve stated before, when it comes to testing, maintenance is king.</p>

<p>Anyway, if you have a hard dependency on the file system, consider the alternatives. This is never a <strong>hard</strong> rule as it is not suitable for all uses, but it always worth thinking about.</p>

<h3 id="alternative-approaches">Alternative approaches</h3>

<p>Firstly, <a href="http://stackoverflow.com/questions/1528134/unit-testing-file-i-o/1528243#1528243">abstract the file operations to</a> some degree. You can do numerous things here, from changing the internal loading strategy (via <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>) to - even better - separating the loading/use of the file so that the consumer of the file’s contents <strong>doesn’t even have to care</strong> about the loading strategy.</p>

<p>Once you’ve done this, you no longer need to use files in your unit tests, as you can use plain ol’ strings, streams or even just directly construct instances to represent the contents of the file.</p>

<p>Say we had a simple class called “MyDocument”, and MyDocument could be loaded from a .doc file on disk. The simplest approach would be to do something like this:</p>

<h4 id="approach-one">Approach One</h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// #1: this is tightly coupled to file system. </span>
<span class="k">void</span> <span class="nf">SimpleLoading</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">simpleDocument</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyDocument</span><span class="p">(</span><span class="s">"filenameToLoad.doc"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Depending on your needs and the demands of the user, this may be OK. However, to test MyDocument’s methods/properties properly, we need access to the file system to instantiate it. If our tests are to be robust &amp; fast, we need something better. Here’s something that’s testable:</p>

<h4 id="approach-two">Approach Two</h4>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// #2: doc calls DocumentLoader's methods to get data needed</span>
<span class="k">void</span> <span class="nf">SlightlyImprovedAndTestable</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// this type implements IDocumentLoader</span>
  <span class="kt">var</span> <span class="n">docLoaderStrategy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileDocumentLoader</span><span class="p">(</span><span class="s">"filenameToLoad.doc"</span><span class="p">);</span>

  <span class="c1">// Uses DI; ctor calls doc loader's methods to construct itself</span>
  <span class="kt">var</span> <span class="n">doc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyDocumentType</span><span class="p">(</span><span class="n">docLoaderStrategy</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From a testability standpoint, this is slightly better, as we can now feed in an IDocumentLoader instance which the MyDocument constructor uses to get the data.</p>

<p>On the flipside, the MyDocument type now needs to know about IDocumentLoader. To load a document, the user now needs to know about creating an IDocumentLoader and feeding it into the constructor - it’s more complicated. I often see people do this as the default step for abstracting their file operations - they alter the code to make it testable, but fail to spot the problems it brings if done at the wrong ‘level’. If you gnash your teeth every time you have to use your own code, it’s a warning sign that something is wrong.</p>

<p>When we think about it though, why should MyDocument need to know about loading strategies? In many cases, we can parse a file and produce some output using a factory or builder instead. E.g.:</p>

<h4 id="approach-three">Approach Three</h4>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// #3: Break loading + doc creation into two distinct parts</span>
<span class="k">void</span> <span class="nf">DecoupledAndTestable</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// loading is now a separate step :)</span>
  <span class="n">MyDocument</span> <span class="n">doc</span><span class="p">;</span>
  <span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">docLoader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DocumentLoader</span><span class="p">(</span><span class="s">"filenameToLoad.doc"</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">doc</span> <span class="p">=</span> <span class="n">docLoader</span><span class="p">.</span><span class="nf">LoadDocument</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Similarly, we can do something like this</span>
  <span class="kt">var</span> <span class="n">testDoc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TestLoader</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">LoadDocumentFromText</span><span class="p">(</span><span class="n">SomeResourceFile</span><span class="p">.</span><span class="n">ValidDocument</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To clarify how this works: The DocumentLoader would parse the .doc file and construct the object instances required to build up a real document, then pass them into the document’s constructor (or build up the document via some other means, such as iteratively calling methods on a blank document to fill it up as new items are found - whatever makes sense). This totally decouples the loading and instantiation, meaning we can test each step in isolation.</p>

<p>I.e. the flow goes: Read Input =&gt; Parse Input =&gt; Create Document from Parsed Input</p>

<h3 id="life-after-the-file-system">Life after the File System</h3>

<p>Once you’re no longer dependent on the file system, you are free to use one of many strategies for loading/creating your type. Depending on the abstraction, some options include:</p>

<ul>
  <li>
    <p>Just declare your data inline in the test methods as a const string, or as a const/readonly field of the test fixture. This works well for small amounts of text.</p>
  </li>
  <li>Add your test files as text file resources. You can then access the file contents as a static string property. This is handy, as you get a strongly typed resource name and don’t need to mess around with paths + copying files. This works well for larger sets of data, or data you want to re-use in multiple tests.</li>
  <li>Use embedded resources &amp; <a href="http://msdn.microsoft.com/en-us/library/xc4235zt.aspx">GetManifestResourceStream</a>. This is slightly messier; it doesn’t require copying files, but it does require that the namespace + filenames used to reference the embedded resources are correct (runtime failures ahoy). You also need to handle streams when using this method.</li>
</ul>

<p>If my loading logic deals with strings, I tend to just build an ‘inner’ parser that works with the strings, then wrap it in another class that opens and reads files, then passes the (raw) string to the ‘inner’ parser class. This allows me to thoroughly test the parsing logic independent of the file system, but also means I can re-use it for test classes or other cases. I.e. I can exercise more of the production code without any of the file system pain :)</p>

<p>Depending on the thing being loaded, this isn’t always the best solution, but for relatively simple loading I tend to favour this method.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/tags/c" class="page__taxonomy-item" rel="tag">c#</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/patterns" class="page__taxonomy-item" rel="tag">patterns</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/testing" class="page__taxonomy-item" rel="tag">testing</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2009-11-26T20:21:31+00:00">November 26, 2009</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Avoiding+the+file+system%20https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F11%2F26%2Favoiding-the-file-system.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F11%2F26%2Favoiding-the-file-system.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F11%2F26%2Favoiding-the-file-system.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/2009/10/31/no-longer-a-software-engineer-in-test.html" class="pagination--pager" title="No longer a software engineer in test
">Previous</a>
    
    
      <a href="/blog/2009/12/07/mouse-input-in-fps-games.html" class="pagination--pager" title="Mouse Input in FPS Games
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/10/the-fundamentals-of-automated-testing-setup-structure.html" rel="permalink">The fundamentals of unit testing: Setup structure
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/05/the-fundamentals-of-automated-testing-data-driven-tests.html" rel="permalink">The fundamentals of unit testing: Data-driven tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/02/goodbye-wordpress-hello-jekyll-and-github-pages.html" rel="permalink">Goodbye Wordpress, Hello Jekyll and Github Pages
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve been using Wordpress with 34sp.com hosting since the late noughties, and it’s time for a 
change.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/03/29/nvidia-g-sync-black-screen-when-alt-tabbing.html" rel="permalink">Nvidia + G-SYNC - Black screen when alt-tabbing
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">tl;dr: It seems G-SYNC related. I fixed it by installing the monitor driver, then toggling G-SYNC on/off.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Mark's Devblog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
