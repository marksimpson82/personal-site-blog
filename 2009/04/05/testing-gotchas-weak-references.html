<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Testing gotchas - c# Weak References - Mark’s Devblog</title>
<meta name="description" content="If you ever have to test a class that uses a WeakReference, or even just have to use Weak References, be very careful. Numerous strange-looking things can occur when Weak References are involved.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Mark's Devblog">
<meta property="og:title" content="Testing gotchas - c# Weak References">
<meta property="og:url" content="https://marksimpson82.github.io/blog/2009/04/05/testing-gotchas-weak-references.html">


  <meta property="og:description" content="If you ever have to test a class that uses a WeakReference, or even just have to use Weak References, be very careful. Numerous strange-looking things can occur when Weak References are involved.">







  <meta property="article:published_time" content="2009-04-05T02:55:49+00:00">





  

  


<link rel="canonical" href="https://marksimpson82.github.io/blog/2009/04/05/testing-gotchas-weak-references.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mark's Devblog",
      "url": "https://marksimpson82.github.io/blog/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Mark's Devblog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/blog/">
          Mark's Devblog
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Testing gotchas - c# Weak References">
    <meta itemprop="description" content="If you ever have to test a class that uses a WeakReference, or even just have to use Weak References, be very careful. Numerous strange-looking things can occur when Weak References are involved.">
    <meta itemprop="datePublished" content="2009-04-05T02:55:49+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Testing gotchas - c# Weak References
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>If you ever have to test a class that uses a <a href="http://msdn.microsoft.com/en-us/library/system.weakreference.aspx">WeakReference</a>, or even just have to <em>use</em> Weak References, be very careful. Numerous strange-looking things can occur when <a href="http://msdn.microsoft.com/en-us/library/system.weakreference.aspx">Weak References</a> are involved.</p>

<p>If you have even a cursory understanding of the <a href="http://msdn.microsoft.com/en-us/library/0xy59wtx.aspx">.NET Garbage Collector</a> (GC), you will know that it keeps track of objects. When an object is no longer strongly referenced, the GC will potentially collect it, freeing up its resources. This causes the object to ‘disappear’. So, if you have a strong reference to an object in your program, you are generally safe in the assumption that the object will stick around. The GC won’t pull the carpet from under you while you’re using that object.</p>

<p>Weak References, on the other hand, do <strong>not</strong> stop the GC from collecting the object they refer to. In certain circumstances, it can be advantageous to use Weak References because you do want to use/observe/whatever an object, but you don’t want to stop it from being collected. So far so good. All obvious stuff.</p>

<h3 id="the-gc-moves-in-mysterious-ways">The GC moves in mysterious ways</h3>

<p>OK you say, what’s the point in this article? The point is that GC is extremely clever. Almost a little too clever. So clever it may aggressively collect objects to the point where it can mess with your head, and your tests. This ‘problem’ can manifest itself in subtle ways - certain types of tests involving Weak References will usually pass in debug mode, but may sporadically fail in release mode. Heads will be scratched. Bemused gurning will commence.</p>

<h3 id="obligatory-contrived-example">Obligatory Contrived Example</h3>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">GuyWhoUsesWeakRef</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="n">WeakReference</span> <span class="n">m_weakBuilder</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">GuyWhoUsesWeakRef</span><span class="p">(</span><span class="n">StringBuilder</span> <span class="n">_builder</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_weakBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeakReference</span><span class="p">(</span><span class="n">_builder</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsWeakRefValid</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_weakBuilder</span><span class="p">.</span><span class="n">Target</span> <span class="p">!=</span> <span class="k">null</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">IsWeakRefValid_WhenValidRef_ReturnsTrue_Test</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">builder</span>     <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
  <span class="kt">var</span> <span class="n">usesWeakRef</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GuyWhoUsesWeakRef</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

  <span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">usesWeakRef</span><span class="p">.</span><span class="n">IsWeakRefValid</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">True</span><span class="p">,</span>
    <span class="s">"Operation relying on the weak reference should've succeeded"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="why-does-this-occasionally-fail">Why does this occasionally fail?</h3>

<p>If you look carefully, you may spot the problem. Recall that I said that objects can be collected <strong>while still in scope</strong>. After the builder reference has been passed to the GuyWhoUsesWeakRef constructor, it is no longer used anywhere. The GuyWhoUsesWeakRef class doesn’t take a strong reference, so the moment the parameter is no longer used, that reference also gets discarded.</p>

<p>As a result, immediately after the new GuyWhoUsesWeakRef(builder) call, the GC figures out that the StringBuilder object we’ve created will never be used again. After all, if the object is never used again, why not collect it as soon as possible?</p>

<p>In debug mode, this won’t throw a spanner in the works. The test will pass because the GC is not aggressively collecting. However, in release mode, the GC may well collect the StringBuilder when we fully expect it to still be alive for our Assert.That() call.</p>

<p>The main problem is that it won’t happen every time. The GC is <em>non-deterministic</em>, so this test will pass and fail intermittently; it depends on the timing of the collection. Coming from C++ where objects are destroyed as they exit scope, I found this somewhat bemusing. In the context of the GC, it makes sense, though. You just have to be careful.</p>

<h3 id="the-solution">The solution</h3>

<p>The good folks at Microsoft they provided a very simple static method call to solve this particular problem; enter <a href="http://msdn.microsoft.com/en-us/library/system.gc.keepalive.aspx">GC.KeepAlive</a>. Placing a call to GC.KeepAlive(builder) at the end of this test method will ensure that the object we’re referring to will not be collected until after the GC.KeepAlive call has been made. Problem solved.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">IsWeakRefValid_WhenValidRef_ReturnsTrue_Test</span><span class="p">()</span>
<span class="p">{</span>
 <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
 <span class="kt">var</span> <span class="n">usesWeakRef</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GuyWhoUsesWeakRef</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

 <span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">usesWeakRef</span><span class="p">.</span><span class="n">IsWeakRefValid</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">True</span><span class="p">,</span>
 <span class="s">"Operation relying on the weak reference should've succeeded"</span><span class="p">);</span>

  <span class="n">GC</span><span class="p">.</span><span class="nf">KeepAlive</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span> <span class="c1">// weak ref is now valid up to this point</span>
<span class="p">}</span>
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/tags/c" class="page__taxonomy-item" rel="tag">c#</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/gotchas" class="page__taxonomy-item" rel="tag">gotchas</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tags/testing" class="page__taxonomy-item" rel="tag">testing</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2009-04-05T02:55:49+00:00">April 5, 2009</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Testing+gotchas+-+c%23+Weak+References%20https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F04%2F05%2Ftesting-gotchas-weak-references.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F04%2F05%2Ftesting-gotchas-weak-references.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fmarksimpson82.github.io%2Fblog%2F2009%2F04%2F05%2Ftesting-gotchas-weak-references.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/2009/04/04/modding-avoid-making-the-same-mistakes-that-i-did-7.html" class="pagination--pager" title="Modding: Avoid making the same mistakes that I did #7
">Previous</a>
    
    
      <a href="/blog/2009/04/10/the-test-data-builder-pattern-with-c-30.html" class="pagination--pager" title="The Test Data Builder pattern with C# 3.0
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/10/the-fundamentals-of-automated-testing-setup-structure.html" rel="permalink">The fundamentals of unit testing: Setup structure
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/05/the-fundamentals-of-automated-testing-data-driven-tests.html" rel="permalink">The fundamentals of unit testing: Data-driven tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This post is part of a series on unit testing.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/08/02/goodbye-wordpress-hello-jekyll-and-github-pages.html" rel="permalink">Goodbye Wordpress, Hello Jekyll and Github Pages
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I’ve been using Wordpress with 34sp.com hosting since the late noughties, and it’s time for a 
change.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/blog/2020/03/29/nvidia-g-sync-black-screen-when-alt-tabbing.html" rel="permalink">Nvidia + G-SYNC - Black screen when alt-tabbing
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">tl;dr: It seems G-SYNC related. I fixed it by installing the monitor driver, then toggling G-SYNC on/off.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Mark's Devblog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/blog/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
